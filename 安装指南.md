# VRChat语音翻译插件 - 安装指南

## 快速开始

### 1. 环境准备

#### 系统要求
- Windows 10/11 (64位)
- Python 3.8 或更高版本
- 8GB+ RAM
- 可选：NVIDIA GPU (支持CUDA)

#### 检查Python版本
```bash
py --version
# 应该显示 Python 3.8+ 版本
```

### 2. 下载项目

#### 方法1：Git克隆
```bash
git clone <项目地址>
cd Qwesen
```

#### 方法2：直接下载
下载项目文件到本地目录，确保包含以下文件：
- `VRchat_videoRest.py` (主程序)
- `settings.json` (配置文件)
- `requirements.txt` (依赖列表)

### 3. 安装依赖

#### 安装基础依赖
```bash
# 升级pip
py -m pip install --upgrade pip

# 安装项目依赖
py -m pip install -r requirements.txt
```

#### 安装PyAudio (Windows)
如果PyAudio安装失败，使用预编译版本：
```bash
# 方法1：使用pipwin
py -m pip install pipwin
py -m pipwin install pyaudio

# 方法2：下载对应版本的.whl文件
# 访问 https://www.lfd.uci.edu/~gohlke/pythonlibs/#pyaudio
# 下载对应Python版本的.whl文件
py -m pip install PyAudio-0.2.11-cp313-cp313-win_amd64.whl
```

#### 安装CUDA支持 (可选)
如果需要GPU加速：
```bash
# 安装CUDA版本的PyTorch
py -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

### 4. 配置API

#### 编辑settings.json
```json
{
  "api_key": "你的API密钥",
  "api_url": "https://api.siliconflow.cn/v1/chat/completions",
  "model": "Pro/deepseek-ai/DeepSeek-V3",
  "speech_engine": "whisper",
  "silence_threshold": 500,
  "silence_duration": 2.0
}
```

#### 获取API密钥
1. 注册SiliconFlow账号
2. 创建API密钥
3. 将密钥填入settings.json

### 5. 下载Whisper模型

#### 自动下载
首次运行程序时会自动下载：
```bash
py VRchat_videoRest.py
```

#### 手动下载
```bash
# 下载medium模型（推荐）
py -c "from faster_whisper import WhisperModel; WhisperModel('medium')"
```

### 6. 配置VRChat

#### 启用OSC功能
1. 打开VRChat
2. 进入设置菜单
3. 找到OSC选项
4. 启用OSC功能
5. 设置接收端口为9000

## 详细安装步骤

### 步骤1：Python环境检查

```bash
# 检查Python版本
py --version

# 检查pip版本
py -m pip --version

# 检查是否在PATH中
where python
where py
```

### 步骤2：创建虚拟环境 (推荐)

```bash
# 创建虚拟环境
py -m venv vrchat_env

# 激活虚拟环境
vrchat_env\Scripts\activate

# 升级pip
py -m pip install --upgrade pip
```

### 步骤3：安装依赖包

```bash
# 安装基础包
py -m pip install pyaudio==0.2.11
py -m pip install faster-whisper==0.10.0
py -m pip install keyboard==0.13.5
py -m pip install requests==2.31.0
py -m pip install python-osc==1.8.1
py -m pip install pynvml==12.0.0

# 或者使用requirements.txt
py -m pip install -r requirements.txt
```

### 步骤4：验证安装

```bash
# 测试PyAudio
py -c "import pyaudio; print('PyAudio安装成功')"

# 测试Faster-Whisper
py -c "from faster_whisper import WhisperModel; print('Faster-Whisper安装成功')"

# 测试键盘监听
py -c "import keyboard; print('Keyboard安装成功')"

# 测试GPU检测
py -c "import pynvml; print('PyNVML安装成功')"
```

### 步骤5：配置API密钥

#### 获取SiliconFlow API密钥
1. 访问 https://api.siliconflow.cn
2. 注册账号并登录
3. 创建API密钥
4. 复制密钥到settings.json

#### 测试API连接
```bash
py -c "
import requests
import json

with open('settings.json', 'r') as f:
    settings = json.load(f)

headers = {
    'Authorization': f'Bearer {settings[\"api_key\"]}',
    'Content-Type': 'application/json'
}

data = {
    'model': settings['model'],
    'messages': [{'role': 'user', 'content': 'Hello'}],
    'max_tokens': 50
}

response = requests.post(settings['api_url'], headers=headers, json=data)
print(f'API测试结果: {response.status_code}')
if response.status_code == 200:
    print('API连接成功')
else:
    print(f'API连接失败: {response.text}')
"
```

### 步骤6：下载Whisper模型

#### 检查模型下载
```bash
# 检查模型缓存目录
dir %USERPROFILE%\.cache\huggingface\hub

# 手动下载模型
py -c "from faster_whisper import WhisperModel; model = WhisperModel('medium'); print('模型下载完成')"
```

### 步骤7：测试完整功能

```bash
# 运行主程序
py VRchat_videoRest.py
```

## 故障排除

### 常见安装问题

#### 1. PyAudio安装失败
```bash
# 解决方案1：使用pipwin
py -m pip install pipwin
py -m pipwin install pyaudio

# 解决方案2：下载预编译版本
# 访问 https://www.lfd.uci.edu/~gohlke/pythonlibs/#pyaudio
# 下载对应版本的.whl文件

# 解决方案3：使用conda
conda install pyaudio
```

#### 2. CUDA安装问题
```bash
# 检查CUDA版本
nvidia-smi

# 安装对应版本的PyTorch
py -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 测试CUDA支持
py -c "import torch; print(f'CUDA可用: {torch.cuda.is_available()}')"
```

#### 3. 模型下载失败
```bash
# 检查网络连接
ping huggingface.co

# 使用代理（如果需要）
set HTTPS_PROXY=http://proxy:port

# 手动下载模型文件
# 参考 模型下载指南.md
```

#### 4. 权限问题
```bash
# 以管理员身份运行命令提示符
# 右键点击命令提示符 -> 以管理员身份运行

# 或者修改用户权限
```

### 运行时问题

#### 1. 麦克风权限
- 检查Windows麦克风权限设置
- 确认默认录音设备设置
- 测试麦克风是否正常工作

#### 2. VRChat OSC问题
- 确认VRChat OSC功能已启用
- 检查端口9000是否被占用
- 确认VRChat正在运行

#### 3. API连接问题
- 检查网络连接
- 确认API密钥正确
- 检查API配额是否充足

## 性能优化

### 系统优化
1. **关闭不必要的程序**
2. **增加虚拟内存**
3. **使用SSD存储**
4. **确保足够的RAM**

### GPU优化
1. **更新显卡驱动**
2. **关闭其他GPU程序**
3. **调整显存阈值**
4. **使用合适的模型大小**

### 网络优化
1. **使用有线网络**
2. **关闭VPN（如果不需要）**
3. **检查防火墙设置**

## 更新和维护

### 更新依赖
```bash
# 更新所有包
py -m pip install --upgrade -r requirements.txt

# 更新特定包
py -m pip install --upgrade faster-whisper
```

### 清理缓存
```bash
# 清理pip缓存
py -m pip cache purge

# 清理模型缓存
rmdir /s %USERPROFILE%\.cache\huggingface\hub
```

### 备份配置
```bash
# 备份settings.json
copy settings.json settings_backup.json

# 备份模型文件
xcopy %USERPROFILE%\.cache\huggingface\hub D:\backup\models /E /I
```

## 技术支持

### 获取帮助
1. 查看错误日志
2. 检查系统要求
3. 参考故障排除指南
4. 联系技术支持

### 日志文件
程序运行时会显示详细的日志信息，包括：
- GPU显存使用情况
- 模型加载状态
- API连接状态
- 错误信息

### 常见错误代码
- `ModuleNotFoundError`: 依赖包未安装
- `CUDA out of memory`: GPU显存不足
- `ConnectionError`: 网络连接问题
- `PermissionError`: 权限不足

## 许可证

本项目采用MIT许可证，详见LICENSE文件。 